# 微信小程序隐私配置说明

## 已完成的配置（基于腾讯官方推荐）

✅ **1. 在 app.json 中添加了隐私保护配置**
```json
{
  "__usePrivacyCheck__": true
}
```
- `__usePrivacyCheck__`: 开启隐私保护检查

**⚠️ 注意：`requiredPrivateInfos` 只用于位置相关接口**
- `requiredPrivateInfos` 字段只需要在使用位置相关接口时配置
- 支持的值：`chooseAddress`, `chooseLocation`, `choosePoi`, `getFuzzyLocation`, `getLocation`, `onLocationChange`, `startLocationUpdate`, `startLocationUpdateBackground`
- **`getPhoneNumber` 不需要在此声明**，它的隐私授权通过隐私弹窗组件自动处理

✅ **2. 创建了隐私协议弹窗组件**
- 位置：`/components/privacy-popup/`
- 功能：自动监听隐私授权需求，在需要时弹出协议
- 使用了官方推荐的 API：
  - `wx.onNeedPrivacyAuthorization`: 监听隐私授权需求
  - `wx.getPrivacySetting`: 获取隐私授权状态
  - `wx.requirePrivacyAuthorize`: 触发隐私授权（备用方案）
  - `wx.openPrivacyContract`: 打开隐私协议详情

✅ **3. 在 app.js 中添加了隐私授权初始化逻辑**
- 在小程序启动时检查隐私授权状态
- 打印调试信息便于排查问题

✅ **4. 在首页和登录页添加了隐私弹窗组件**
- 确保用户在使用隐私接口前看到并同意协议
- 在登录页添加了详细的错误处理逻辑

✅ **5. 完善登录页面的隐私授权检查**
- 在 `onLoad` 时检查隐私授权状态
- 在获取手机号时处理各种授权情况
- 添加了友好的错误提示

---

## 需要在微信小程序后台配置的内容

### 第一步：登录微信小程序后台

1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 使用管理员账号登录你的小程序

### 第二步：配置隐私保护指引

1. 进入【设置】→【服务内容声明】→【用户隐私保护指引】
2. 点击【设置】或【编辑】按钮
3. 填写隐私保护指引内容

### 第三步：声明使用的隐私接口

根据你的小程序实际使用的接口，需要在后台声明以下内容：

#### 当前小程序使用的隐私接口：

1. **获取手机号（getPhoneNumber）**
   - 使用场景：登录页面
   - 用途说明：用于用户一键登录
   - 需要声明的内容示例：
     ```
     用途：用于用户快速登录，验证用户身份
     场景：当用户点击"微信手机号一键登录"按钮时
     ```

2. **其他可能需要声明的接口**（根据你的实际使用情况）：
   - 用户信息（getUserProfile）
   - 位置信息（getLocation）
   - 相机/相册（chooseImage）
   - 等等

### 第四步：编写隐私保护指引内容模板

在微信后台的隐私保护指引编辑器中，可以参考以下模板：

```
【隐私保护指引】

生效日期：[填写日期]

更新日期：[填写日期]

【引言】
欢迎使用宠物鱼小程序！我们非常重视您的隐私保护和个人信息保护。本隐私保护指引旨在向您说明我们如何收集、使用、存储和保护您的个人信息，以及您所享有的相关权利。

【我们如何收集和使用您的个人信息】

1. 手机号码
   - 收集场景：当您选择使用"微信手机号一键登录"时
   - 收集方式：通过微信提供的手机号快捷填写功能
   - 使用目的：用于快速登录、身份验证和账号管理
   - 是否必要：非必要，您可以选择其他方式使用小程序

【我们如何存储和保护您的个人信息】

我们会采取以下措施保护您的个人信息：
- 使用加密技术确保数据传输安全
- 严格限制访问权限，仅授权人员可访问
- 定期进行安全审计和风险评估

【您的权利】

您对您的个人信息享有以下权利：
- 访问权：您有权访问您的个人信息
- 更正权：您有权更正不准确的个人信息
- 删除权：您有权要求删除您的个人信息
- 撤回同意权：您有权随时撤回对个人信息处理的同意

【联系我们】

如您对本隐私保护指引有任何疑问、意见或建议，请通过以下方式联系我们：
- 小程序内反馈
- 邮箱：[填写您的联系邮箱]

【更新】

我们可能会不定期更新本隐私保护指引。更新后的指引会在小程序中公示，并在您下次使用时以弹窗形式提示。
```

### 第五步：提交审核

1. 完成隐私保护指引的编写后，点击【提交审核】
2. 等待微信官方审核通过（通常1-3个工作日）
3. 审核通过后，隐私弹窗就会在小程序中正常工作

---

## 常见问题解答

### Q1: 隐私弹窗什么时候会显示？

**A:** 当用户首次使用小程序，或者调用需要隐私授权的接口（如获取手机号）时，系统会自动触发隐私弹窗。

### Q2: 用户拒绝隐私协议会怎样？

**A:** 用户拒绝后，无法使用需要隐私授权的功能（如一键登录），但可以继续浏览小程序的其他内容。

### Q3: 如何测试隐私弹窗？

**A:** 
1. 在微信开发者工具中，打开【详情】→【本地设置】
2. 勾选【启用隐私相关功能】
3. 重新编译小程序，即可看到隐私弹窗

### Q4: 报错 "errno":101 是什么意思？

**A:** 这个错误表示隐私接口调用失败，常见原因：

1. **小程序后台未配置隐私保护指引** ⭐ 最常见
   - 解决：在微信公众平台配置隐私保护指引并通过审核
   - 路径：【设置】→【服务内容声明】→【用户隐私保护指引】

2. **未开启隐私检查**
   - 解决：在 `app.json` 中添加 `"__usePrivacyCheck__": true`

3. **用户未同意隐私协议就调用了隐私接口**
   - 解决：使用隐私弹窗组件，等用户同意后再调用

4. **使用位置相关接口但未声明**
   - 如果使用了位置相关接口（如 `getLocation`），需要在 `app.json` 中添加：
   ```json
   {
     "requiredPrivateInfos": ["getLocation"]
   }
   ```
   - ⚠️ 注意：`getPhoneNumber` 不需要在此声明

**完整的错误处理示例：**

```javascript
// 在获取手机号时处理各种错误
onGetPhoneNumber(e) {
  const errMsg = e.detail.errMsg;
  
  if (errMsg === 'getPhoneNumber:ok') {
    // 成功获取
    this.loginWithPhone(e.detail.code);
  } else if (errMsg === 'getPhoneNumber:fail user deny') {
    // 用户拒绝授权
    wx.showToast({ title: '需要授权手机号才能登录', icon: 'none' });
  } else if (errMsg.includes('privacy')) {
    // 用户未同意隐私协议
    wx.showModal({
      title: '提示',
      content: '需要同意隐私协议才能使用该功能',
      showCancel: false,
    });
  } else {
    // 其他错误
    wx.showToast({ title: '获取手机号失败', icon: 'none' });
  }
}
```

### Q5: `getPhoneNumber` 需要在 `requiredPrivateInfos` 中声明吗？

**A:** ❌ **不需要！**

**重要说明：**
- `requiredPrivateInfos` 字段**只用于位置相关接口**
- 支持的接口：`chooseAddress`, `chooseLocation`, `choosePoi`, `getFuzzyLocation`, `getLocation`, `onLocationChange`, `startLocationUpdate`, `startLocationUpdateBackground`
- `getPhoneNumber`、`getUserProfile` 等接口**不需要**在此声明
- 这些接口的隐私授权通过**隐私弹窗组件**自动处理

**正确的配置：**
```json
{
  "__usePrivacyCheck__": true
  // 如果不使用位置接口，不需要 requiredPrivateInfos
}
```

**如果使用位置接口，才需要声明：**
```json
{
  "__usePrivacyCheck__": true,
  "requiredPrivateInfos": [
    "getLocation",
    "chooseLocation"
  ]
}
```

### Q6: 如何在开发环境中跳过隐私检查？

**A:** 不建议跳过。但如果需要测试，可以在微信开发者工具中：
- 【详情】→【本地设置】→取消勾选【启用隐私相关功能】
- 注意：正式发布时必须配置隐私保护指引

---

## 技术实现说明（腾讯官方推荐）

### 隐私弹窗组件工作原理

#### 方式1：自动触发（推荐）✅

当用户点击需要隐私授权的按钮时，系统会自动触发隐私弹窗：

```javascript
// 1. 监听隐私授权需求
wx.onNeedPrivacyAuthorization((resolve) => {
  console.log('触发隐私授权需求');
  // 显示自定义隐私弹窗
  this.setData({ show: true, resolvePrivacyAuthorization: resolve });
});

// 2. 用户同意后调用 resolve
handleAgree() {
  if (this.data.resolvePrivacyAuthorization) {
    this.data.resolvePrivacyAuthorization({ 
      event: 'agree',
      buttonId: 'agree-btn' 
    });
  }
}
```

#### 方式2：手动触发（备用）

在某些场景下，可以手动触发隐私授权：

```javascript
// 使用 wx.requirePrivacyAuthorize 手动触发
wx.requirePrivacyAuthorize({
  success: () => {
    console.log('隐私授权成功');
    // 继续后续操作
  },
  fail: (err) => {
    console.error('隐私授权失败:', err);
  }
});
```

#### 关键 API 说明

1. **wx.getPrivacySetting** - 检查隐私授权状态
   ```javascript
   wx.getPrivacySetting({
     success: (res) => {
       console.log('needAuthorization:', res.needAuthorization); // 是否需要授权
       console.log('privacyContractName:', res.privacyContractName); // 协议名称
     }
   });
   ```

2. **wx.onNeedPrivacyAuthorization** - 监听隐私授权需求
   ```javascript
   wx.onNeedPrivacyAuthorization((resolve) => {
     // 显示隐私弹窗
     // 用户同意后调用 resolve({ event: 'agree' })
     // 用户拒绝后调用 resolve({ event: 'disagree' })
   });
   ```

3. **wx.requirePrivacyAuthorize** - 手动触发隐私授权
   ```javascript
   wx.requirePrivacyAuthorize({
     success: () => { /* 授权成功 */ },
     fail: () => { /* 授权失败 */ }
   });
   ```

4. **wx.openPrivacyContract** - 打开隐私协议详情
   ```javascript
   wx.openPrivacyContract({
     success: () => { 
       // 打开微信内置的隐私协议页面
     }
   });
   ```

5. **同意按钮配置**
   ```html
   <!-- 使用 open-type="agreePrivacyAuthorization" -->
   <button 
     open-type="agreePrivacyAuthorization" 
     bindagreeprivacyauthorization="handleAgree">
     同意
   </button>
   ```

### 完整工作流程

```
1. 用户打开小程序
   ↓
2. 小程序调用 wx.getPrivacySetting 检查授权状态
   ↓
3. 用户点击"获取手机号"按钮 (open-type="getPhoneNumber")
   ↓
4. 如果需要授权，系统触发 wx.onNeedPrivacyAuthorization
   ↓
5. 显示自定义隐私弹窗
   ↓
6. 用户点击"同意"按钮 (open-type="agreePrivacyAuthorization")
   ↓
7. 调用 resolve({ event: 'agree' })
   ↓
8. 继续执行获取手机号流程
   ↓
9. 在 bindgetphonenumber 回调中处理手机号
```

### 关键配置文件

- **app.json**: 全局配置，开启隐私检查
- **components/privacy-popup/**: 隐私弹窗组件
- **app.js**: 初始化隐私授权逻辑

---

## 检查清单

在提交小程序审核前，请确认：

- [ ] ✅ app.json 中已添加 `"__usePrivacyCheck__": true`
- [ ] ✅ 已创建隐私弹窗组件 `/components/privacy-popup/`
- [ ] ✅ 在使用隐私接口的页面添加了 `<privacy-popup />`
- [ ] ⚠️ **不要**添加 `requiredPrivateInfos`（除非使用位置接口）
- [ ] ⏳ 微信小程序后台已配置隐私保护指引
- [ ] ⏳ 隐私保护指引已通过微信审核
- [ ] ✅ 在开发者工具中测试隐私弹窗正常显示
- [ ] ✅ 测试同意/拒绝隐私协议的流程
- [ ] ✅ 测试获取手机号的完整流程

**图例说明：**
- ✅ 代码配置（已完成）
- ⏳ 后台配置（需要手动完成）
- ⚠️ 注意事项

---

## 相关文档链接

- [微信小程序隐私保护指引](https://developers.weixin.qq.com/miniprogram/dev/framework/user-privacy/)
- [隐私接口检测工具](https://developers.weixin.qq.com/miniprogram/dev/framework/user-privacy/PrivacyAuthorize.html)
- [小程序用户隐私保护指引填写说明](https://developers.weixin.qq.com/community/develop/doc/000a0e3f904840fb0c2c7be065b001)

---

如有任何问题，请参考微信官方文档或联系技术支持。

